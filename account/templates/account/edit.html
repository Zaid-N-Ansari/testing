{% extends "base.html" %}
{% block title %}Profile{% endblock title %}
{% load static %}
{% block content %}

<link type="text/css" rel="stylesheet" href="{% static 'cropperjs/dist/cropper.min.css' %}">
<script src="{% static 'cropperjs/dist/cropper.min.js' %}"></script>

<div class="container h-full">
	<div class="row mt-5 justify-content-center h-100 shadow p-2">
		<div class="col-md-6 col-lg-4 col-12">
			<div class="d-flex justify-content-center justify-content-md-start">
				<div class="position-relative edit" style="width: 30dvh; height: 30dvh;">
					<img class="rounded-circle w-100 h-100 img_edit" src="{{ request.user.profile_image.url }}?{{ request.user.last_login|date:'U' }}"
						alt="Profile Image" loading="lazy" >
					<span
						class="material-icons text-primary position-absolute top-50 start-50 translate-middle p-2 rounded-circle span_edit">edit</span>
				</div>
				<script>
					$(document).ready(function (e) {
						$("span.span_edit").css("opacity", "0");
						$("div.edit").on("mouseenter", function (e) {
							$(this).children("img.img_edit").css({
								"opacity": "0.8",
								"transition": "opacity 200ms ease"
							});
							$(this).children("span.span_edit").css({
								"cursor": "pointer",
								"opacity": "1",
								"transition": "opacity 200ms ease"
							});
						});
						$("div.edit").on("mouseleave", function (e) {
							$(this).children("img.img_edit").css("opacity", "1");
							$(this).children("span.span_edit").css("opacity", "0");
						});
					});
				</script>
			</div>
		</div>
		<div class="col-md-6 col-lg-4 col-10">
			<div class="h-100 w-100 d-md-flex d-lg-flex flex-column justify-content-center mt-3 mt-md-0 mt-lg-0">
				<form spellcheck="false" enctype="multipart/form-data" method="POST">
					{% csrf_token %}
					{{ form.profile_image }}
					<input type="hidden" name="x" id="id_x">
					<input type="hidden" name="y" id="id_y">
					<input type="hidden" name="s" id="id_s">
					<input type="hidden" name="image" id="id_image">
					<div class="row">
						<div class="col">
							{{ form.first_name.label_tag }}
							{{ form.first_name }}
						</div>
						<div class="col">
							{{ form.last_name.label_tag }}
							{{ form.last_name }}
						</div>
					</div>
					<div class="form-group mt-3">
						{{ form.email.label_tag }}
						{{ form.email }}
						{% if form.email.errors %}
						<div class="alert alert-danger alert-dismissible fade show ps-2 p-0 d-flex flex-row align-items-center justify-content-between"
							role="alert">
							<div>
								{% for error in form.email.errors %}
								<p class="mb-0">{{ error }}</p>
								{% endfor %}
							</div>
							<button type="button" class="close float-end bg-transparent border-0 fs-3 text-danger"
								data-dismiss="alert" aria-label="Close">&times;</button>
						</div>
						{% endif %}
					</div>
					<div class="mt-3">
						<a href="{% url 'account:profile' request.user.username %}" class="float-start">
							<button type="button" class="btn btn-danger">
								Back
							</button>
						</a>
						<button type="submit" class="btn btn-success float-end">Save Changes</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<script>
	$("span.span_edit").on("click", function () {
		$("input[type='file']").click();
	});

	function isImgSizeValid(img) {
		var startIndex = img.indexOf("base64,") + 7;
		var base64Str = img.substr(startIndex);
		var decode = atob(base64Str);
		if (decode.length >= 10485760) {
			alert("Image File Size Exceded, should not be greater than 10 MB");
			return null;
		}
		return base64Str;
	}

	function readURL(input) {
		if (input.files && input.files[0]) {
			const reader = new FileReader();
			reader.onload = function (e) {
				let image = e.target.result;
				const imageField = $("img")[1];
				imageField.src = image;
				const cropper = new Cropper(imageField, {
					aspectRatio: 1,
					viewMode: 1,
					crop(event) {
						$("span.span_edit").css("display", "none");
						$("span.point-se").css({
							"height": "5px",
							"width": "5px",
						});
						let x = parseFloat(event.detail.x);
						let y = parseFloat(event.detail.y);
						let s = parseFloat(event.detail.height);
						$("#id_x").val(x);
						$("#id_y").val(y);
						$("#id_s").val(s);
						$("#id_image").val(isImgSizeValid(image));
					}
				});
			};
			reader.readAsDataURL(input.files[0]);
		}
	}
</script>

{% endblock content %}
